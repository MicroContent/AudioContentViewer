<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AudioContentViewer</title>
    <!-- Since GitHub Raw files use text/plain as MIME type the script cannot be executed when linking directly, instead routed over jsdelivr-->
    <script src="https://cdn.jsdelivr.net/gh/MicroContent/BinaryNumberContentViewer/seamless.child.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <style>
        .div-answers {
            margin-top: 2em;
        }

        .correct {
            background: #D4ECC6;
            border-radius: 2em;
        }

        .incorrect {
            background: #E2A1A1;
            border-radius: 2em;
        }

    </style>
    <script type="application/javascript">
        var connection = window.seamless.connect({
            url: window.location.url,
            allowStyleInjection: true,
        });

        connection.receive(function (data) {
            switch (data.type) {
                case 'setContent':
                    // parent for varying type of input sends data as special object; data.main[0] is the array of arrays with your message inside
                    window.data = data.main[0]
                    init();
                    break;

                case 'submit':
                    if (data.value === 'true') {
                        onSubmit();
                    }
                    break;

                case 'getXapiStatements':
                    stmts = data.stmts;
                    break;
            }
        });

        function init() {
            if (window.data === undefined) {
                window.data = {
                    audioUrl: "",
                    isMultipleChoice: true
                };

            } else {
                answerMap = new Map(Object.entries(window.data.answers));
                answerMap.forEach(((value, key) => {
                    window.data.isMultipleChoice? createMultipleChoiceElement(key): createSingleChoiceElement(key);
                }));
            }

            document.getElementById('audio').src = window.data.audioUrl;
        }

        function updateLayout() {
            connection.send({
                type: 'updateLayout'
            });
        }

        function sendStatement(stmt) {
            connection.send({
                type: 'sendXapiStatement',
                stmt: stmt
            });
        }

        function getStatements() {
            connection.send({
                type: 'getXapiStatements'
            });
        }
    </script>
</head>
<body>
<!-- EXAMPLE CODE - EDIT BELOW TO VIEW DATA -->
<div id="content">

    <p id="question"></p>

    <audio controls id="audio"></audio>

    <!-- MULTIPLE CHOICE -->
    <div id="div_answers_mc" class="div-answers">
    </div>


    <!-- SINGLE CHOICE -->
    <div id="div_answers_sc" class="div-answers" >
    </div>

    <div id="statistics"></div> <!--todo necessary?-->

    <button onclick="test()">test stuff</button>

</div>

    <script type="application/javascript">
        function onInteraction() { // todo get selected option
            var stmt = {};
            // actor is set by hosting application
            stmt.actor = undefined;
            stmt.verb = {
                "id": "http://adlnet.gov/expapi/verbs/interacted",
                "display": {
                    "de-DE": "interagierte",
                    "en-US": "interacted",
                    "fr-FR": "a interagi",
                    "es-ES": "interactu√≥"
                }
            };
            stmt.object = getXapiObject();
            var responses = [];

            $("."+optionClassName).each(function (){
                let optionString = $(this).text();
                let isCorrect = answerMap.get(optionString);
                let isChecked = $(this).children(':first').is(':checked');
                if (isChecked){
                    responses.push(optionString) // todo brauch ma correct?
                }
            });
            for (var i = 0; i < 8; i++) {
                if (active[i]) {
                    responses.push(Math.pow(2, (7 - i)).toString());
                }
            }
            stmt.result = {
                response: responses.reduce(function (acc, e) {
                    return (acc.length > 0 && e.length > 0) ? acc + "[,]" + e : acc.length > 0 ? acc : e;
                }, "")
            };
            sendStatement(stmt);
        }

        function test(){
            console.log(getXapiObject());
        }

        function getXapiObject() { // todo
            // may be called on init()



            return {
                "objectType": "Activity",
                // id is set by hosting application
                "id": undefined,
                "definition": {
                    "description": {
                        "de-AT": window.data.question,
                    },
                    "type": "http://adlnet.gov/expapi/activities/cmi.interaction",
                    "interactionType": "choice",
                    "choices": Array.from(answerMap).map(([question, isCorrect], i) => {
                        return {
                            id: i.toString(),
                            description: {
                                "de-AT": question
                            }
                        }
                    }),
                    "correctResponsesPattern": [Array.from(answerMap).map(([question, isCorrect], i) =>{
                        return isCorrect ? i : ""
                    })
                        .reduce(function (acc, e) { // todo chekc if this still works - it doesnt gute nacht
                            return (acc.length > 0 && e.length > 0) ? acc + "[,]" + e : acc.length > 0 ? acc : e;
                        }, "")]
                }
            };
        }

        function createSingleChoiceElement(optionString) {
            /* <div className="radio">
                 <label className="label-answer-r">
                     <input type="radio" className="input-r" name="optcorrect" checked>
                 </label>
             </div>*/
            let divSC = document.createElement('div');
            let labelSC = document.createElement('label');
            labelSC.innerHTML = optionString;
            labelSC.classList.add(optionClassName)
            let radioButton = document.createElement('input');
            radioButton.type = "radio"
            radioButton.name = "radio-btn"
            labelSC.prepend(radioButton);
            divSC.appendChild(labelSC);

            document.getElementById('div_answers_sc').appendChild(divSC);

        }

        function createMultipleChoiceElement(optionString) {
            /*<div class="checkbox">
            <label class="label-answer-cb">
                <input type="checkbox" class="input-cb" name="optcorrect" value="">
            </label>
        </div>*/
            let divMC = document.createElement('div');
            let labelMC = document.createElement('label');
            labelMC.value
            labelMC.innerHTML = optionString;
            labelMC.classList.add(optionClassName);
            let checkBox = document.createElement('input');
            checkBox.type = "checkbox"
            checkBox.name = "checkbox-btn"

            labelMC.prepend(checkBox);
            divMC.prepend(labelMC);

            document.getElementById('div_answers_mc').appendChild(divMC);
        }

        function onSubmit() {
            $("."+optionClassName).each(function (){
                let isCorrect = answerMap.get($(this).text());
                let isChecked = $(this).children(':first').is(':checked');
                if (isCorrect){
                    $(this).addClass('correct');
                } else if(isChecked){
                    $(this).addClass('incorrect');
                }
            });
            updateLayout();
        }

        function showStatistics(result) {
            // todo needed?
            updateLayout();
        }

        function hideStatistics() {
            document.getElementById('statistics').innerHTML = '';
        }

        init();
        const optionClassName = 'option';
        let answerMap;
        let stmts;
        // updateLayout();
    </script>
    <!-- END OF EXAMPLE CODE -->
</body>
</html>